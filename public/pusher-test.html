<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pusher Connection Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold mb-8">üîå Pusher Connection Test</h1>
        
        <div class="bg-gray-800 rounded-xl p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">Connection Status</h2>
            <div id="status" class="text-xl font-mono"></div>
        </div>

        <div class="bg-gray-800 rounded-xl p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">Configuration</h2>
            <div id="config" class="font-mono text-sm space-y-2"></div>
        </div>

        <div class="bg-gray-800 rounded-xl p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">Test Actions</h2>
            <div class="space-y-3">
                <button onclick="testClockIn()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-bold w-full">
                    Test Clock In Event
                </button>
                <button onclick="testClockOut()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-bold w-full">
                    Test Clock Out Event
                </button>
                <button onclick="testLeaveRequest()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-bold w-full">
                    Test Leave Request Event
                </button>
            </div>
        </div>

        <div class="bg-gray-800 rounded-xl p-6">
            <h2 class="text-2xl font-bold mb-4">Event Log</h2>
            <div id="log" class="font-mono text-sm space-y-2 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const APP_KEY = '29d18e6ae1f9ed4b02ce';
        const CLUSTER = 'ap2';
        
        // Display config
        document.getElementById('config').innerHTML = `
            <p><span class="text-gray-400">App Key:</span> ${APP_KEY}</p>
            <p><span class="text-gray-400">Cluster:</span> ${CLUSTER}</p>
            <p><span class="text-gray-400">Channel:</span> attendance-channel</p>
        `;

        // Initialize Pusher
        let pusher, channel;
        
        try {
            // Enable Pusher logging for debugging
            Pusher.logToConsole = true;
            
            pusher = new Pusher(APP_KEY, {
                cluster: CLUSTER,
                forceTLS: true
            });

            channel = pusher.subscribe('attendance-channel');
            
            log('‚úÖ Pusher initialized');
            
            // Connection state changes
            pusher.connection.bind('state_change', function(states) {
                log(`üîÑ State changed: ${states.previous} ‚Üí ${states.current}`);
                updateStatus(states.current);
            });

            pusher.connection.bind('connected', function() {
                log('‚úÖ Connected to Pusher!');
                updateStatus('connected');
            });

            pusher.connection.bind('error', function(err) {
                log('‚ùå Connection error: ' + JSON.stringify(err));
                updateStatus('error');
            });

            // Subscribe to channel events
            channel.bind('pusher:subscription_succeeded', function() {
                log('‚úÖ Subscribed to attendance-channel');
            });

            channel.bind('pusher:subscription_error', function(err) {
                log('‚ùå Subscription error: ' + JSON.stringify(err));
            });

            // Listen for client events
            channel.bind('client-clock-in', function(data) {
                log('üü¢ Received clock-in: ' + JSON.stringify(data));
            });

            channel.bind('client-clock-out', function(data) {
                log('üî¥ Received clock-out: ' + JSON.stringify(data));
            });

            channel.bind('client-leave-request', function(data) {
                log('üìù Received leave-request: ' + JSON.stringify(data));
            });

            channel.bind('client-attendance-update', function(data) {
                log('üìä Received attendance-update: ' + JSON.stringify(data));
            });

        } catch (error) {
            log('‚ùå Failed to initialize Pusher: ' + error.message);
            updateStatus('failed');
        }

        function updateStatus(state) {
            const statusEl = document.getElementById('status');
            const statusMap = {
                'connecting': 'üîÑ Connecting...',
                'connected': '‚úÖ Connected',
                'unavailable': '‚ùå Unavailable',
                'failed': '‚ùå Failed',
                'disconnected': '‚ö†Ô∏è Disconnected',
                'error': '‚ùå Error'
            };
            statusEl.textContent = statusMap[state] || state;
            statusEl.className = state === 'connected' ? 'text-green-400' : 'text-red-400';
        }

        function log(message) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString('en-IN');
            const entry = document.createElement('div');
            entry.className = 'p-2 bg-gray-700 rounded mb-2';
            entry.textContent = `[${time}] ${message}`;
            logEl.insertBefore(entry, logEl.firstChild);
        }

        function testClockIn() {
            if (!channel) {
                log('‚ùå Channel not initialized');
                return;
            }
            
            const data = {
                employeeId: 'TEST123',
                employeeName: 'Test Employee',
                clockIn: new Date().toLocaleTimeString('en-IN'),
                isLate: false,
                timestamp: new Date().toISOString()
            };
            
            try {
                channel.trigger('client-clock-in', data);
                log('üì§ Sent clock-in event: ' + JSON.stringify(data));
            } catch (error) {
                log('‚ùå Failed to send event: ' + error.message);
                log('‚ö†Ô∏è Make sure "Client Events" are enabled in Pusher dashboard!');
            }
        }

        function testClockOut() {
            if (!channel) {
                log('‚ùå Channel not initialized');
                return;
            }
            
            const data = {
                employeeId: 'TEST123',
                employeeName: 'Test Employee',
                clockOut: new Date().toLocaleTimeString('en-IN'),
                duration: '8h 30m',
                timestamp: new Date().toISOString()
            };
            
            try {
                channel.trigger('client-clock-out', data);
                log('üì§ Sent clock-out event: ' + JSON.stringify(data));
            } catch (error) {
                log('‚ùå Failed to send event: ' + error.message);
                log('‚ö†Ô∏è Make sure "Client Events" are enabled in Pusher dashboard!');
            }
        }

        function testLeaveRequest() {
            if (!channel) {
                log('‚ùå Channel not initialized');
                return;
            }
            
            const data = {
                employeeId: 'TEST123',
                employeeName: 'Test Employee',
                leaveType: 'Casual',
                startDate: '2026-01-20',
                endDate: '2026-01-22',
                timestamp: new Date().toISOString()
            };
            
            try {
                channel.trigger('client-leave-request', data);
                log('üì§ Sent leave-request event: ' + JSON.stringify(data));
            } catch (error) {
                log('‚ùå Failed to send event: ' + error.message);
                log('‚ö†Ô∏è Make sure "Client Events" are enabled in Pusher dashboard!');
            }
        }

        // Initial status
        updateStatus('initializing');
        log('üöÄ Starting Pusher connection test...');
    </script>
</body>
</html>
